node {
  stage('Reading the variables from the file')
    {   echo "${env.WORKSPACE}"
        properties = new Properties()
        File propertiesFile = new File("${env.WORKSPACE}"+"./jenkins.properties")
        properties.load(propertiesFile.newDataInputStream())
		echo 'Loaded data from the file'
    }
	echo "===========================checking out the code==================================================="
	echo 'Checking out the code'   
    stage('checkout') {
	 git url: 'https://github.com/mailtorajit/calculatorexample.git'
    // some block
	echo 'checkedout the code'
	 File FileContents = new File("./.git/refs/remotes/origin/master")
	 def Revision_Number=FileContents.text.substring(0,7)
	 Version_Number=properties.Major_Version+'.'+properties.Minor_Version+'.'+Revision_Number+'.'+env.BUILD_NUMBER
	 echo "$Version_Number"
	 executeCommand('mvn -e versions:set -DnewVersion=$Version_Number')
		//if(isUnix()){
    		//sh 'mvn -e versions:set -DnewVersion=$Version_Number'
    	//}
    	//else{
			//bat 'mvn -e versions:set -DnewVersion=$Version_Number'
	//	}
	 echo "================================================================================================="
	}
	
	stage('clean project'){
		echo "=============================cleaning the project======================================================="
    	if(isUnix()){
    		echo 'cleaning'
			sh 'mvn clean'
		}
		else{
			bat 'mvn clean'
		}
			
		echo "================================================================================================="
	}
	stage('compile'){
		echo "==============================compiling the project================================================="
		echo "PATH = ${PATH}"
    	//echo "M2_HOME = ${M2_HOME}"
    	if(isUnix()){
    		sh 'mvn compile'
    	}
    	else{
			bat 'mvn compile'
		}
		echo "================================================================================================="
	}
	
	stage('test execute'){
		echo "==============================Exceuting the tests================================================="
		echo 'inside test'
		if(isUnix()){
    		sh 'mvn test -Dmaven.compile.skip=true'
    	}
    	else{
			bat 'mvn test -Dmaven.compile.skip=true'
		}
		
		echo "================================================================================================="
	}
	
	stage('SonarQube analysis') {
		echo "================================================================================================="
       	def scannerHome = tool 'My SonarQube Server';
		//https://blog.sonarsource.com/breaking-the-sonarqube-analysis-with-jenkins-pipelines/
     	withSonarQubeEnv('SonarQube Scanner') {
     	if(isUnix()){
    		sh "${scannerHome}/bin/sonar-scanner"
    	}
    	else{
			bat "${scannerHome}/bin/sonar-scanner.bat"
		}
        
        echo "=================================================================================================" 
    	}
	}
	
	sleep(10)
	 stage("SonarQube Quality Gate") {
	 	echo "=================================================================================================" 
        timeout(time: 30, unit: 'MINUTES') { 
           def qg = waitForQualityGate() 
           if (qg.status != 'OK') {
             error "Pipeline aborted due to quality gate failure: ${qg.status}"
           }
        }
        echo "================================================================================================="
    }
    
    stage('publish test results'){
    	echo "===========================Publishing the results============================================="
	  	step([$class: 'JacocoPublisher',
      	execPattern:'**/target/coverage-reports/*.exec',
      	classPattern: '**/classes',
      	sourcePattern: '**/src/main/java'])
      	echo "================================================================================================="
	}
	
   	stage('deploy') {
    	echo "=========================Deploying the project========================================================"
    	if(isUnix()){
    		sh 'mvn deploy -Dmaven.compile.skip=true -Dmaven.test.skip=true'
    	}
    	else{
			bat 'mvn deploy -Dmaven.compile.skip=true -Dmaven.test.skip=true'
		}
    	
    	echo "================================================================================================="
	}

	stage("deploy to tomcat"){
		if(isUnix()){
    	//	sh 'ruby sshconn.rb'
    	}
    	else{
			//bat 'ruby sshconn.rb'
		}
		
	}
	
	stage('notify'){
	 notifySuccessful();
	}
	
}

def notifySuccessful() {
   emailext (
       subject: "Project: ${PROJECT_NAME} - Job '${env.JOB_NAME} - [${env.BUILD_NUMBER}]' - - ${BUILD_STATUS}!",
       body: """<p>Project: ${PROJECT_NAME} - Job '${env.JOB_NAME} - [${env.BUILD_NUMBER}]' - - ${BUILD_STATUS}!</p>
         <p>Check console output at "<a href="${env.BUILD_URL}">${env.JOB_NAME} [${env.BUILD_NUMBER}]</a>"</p>""",
       to: "rajkumar.surabhi640@gmail.com", attachLog: true
     )
 }
 
 def executeCommand(String command){
	if(isUnix()){
    		sh command
    	}
    	else{
			bat command
		}
 }

 def Version_Number
 def FilePath1
 def JarFile